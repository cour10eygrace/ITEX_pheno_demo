---
title: "Using confidence intervals to compare the means of different groups"
author: "Courtney G. Collins"
output:
  html_document: default
  pdf_document: default
---
<!-- include = FALSE prevents code and results from appearing in the finished file. R Markdown still runs the code in the chunk, and the results can be used by other chunks. -->
<!-- echo = FALSE prevents code, but not the results from appearing in the finished file. This is a useful way to embed figures. -->


```{r opts, include=FALSE}
knitr::opts_chunk$set(include = FALSE, echo = FALSE, eval=TRUE,tidy.opts=list(width.cutoff=60),tidy=TRUE
  ,cache=TRUE) 
make.pdf <- 'yes'
```


```{r source map script, include=FALSE}
source("C:/Users/court/Documents/Github_repos/ITEX_pheno_demo/scripts/map_fig.R")

```

```{r plot map, include=FALSE, warning=FALSE, fig.width=4, fig.height=2, fig.align='center'}
otc_site_map
```

### Dataset: Long-term plant phenology data from a passive warming experiment 

Today we will be working with a subset of the data from Collins et al (2024) from Alexandra Fiord, in Nunavut, Canada. At this site, researchers have installed passive open top plexiglass chambers (OTCs) across the tundra to experimentally warm tundra plants. These chambers work like mini greenhouses and trap incoming solar radiation to warm their interior by ~1-2 degrees Celsius.

Individual plants were tagged 1 m Ã— 1 m plots either outside (control) or inside of experimental warming open-top chambers (OTCs) for five common tundra species. For 12 years, researchers monitored these plants and recorded the day of year (DOY) when each plant first flowered. DOY is recorded in Julian days (i.e. 1-365) and the timing of flowering typically follows a normal distribution, with peak flowering occurring at the middle of the growing season, and tails on each side for individuals that flower earlier or later.  Let's take a first look at our flowering data. 

```{r load flowering data, include=FALSE}
#load data
load(file='C:/Users/court/Documents/Github_repos/ITEX_pheno_demo/data/AFphen_dem_climate.Rdata')
flowdat<-subset(flower_open, trait_simple2=="flower_no") #no zeroes in dataset
flowdat<-subset(flowdat, doy<210)#get rid of weird tail 
```


```{r plot flowering all, fig.width=4, fig.height=2, fig.align='center', include=TRUE, echo=FALSE}
ggplot(flowdat, aes(x=doy)) +
  geom_histogram(fill="#56B4E9", color="#56B4E9",position="identity", alpha=0.5, bins = 22)+
  #geom_histogram(aes(y=..density..), position="identity", alpha=0.5, binwidth = 7, fill="#56B4E9", color="#56B4E9")+
  geom_density(alpha=0.6)+
  #geom_vline(data=mu, aes(xintercept=grp.mean, color=sex),
  #           linetype="dashed")+
  #scale_color_manual(values="#56B4E9")+
  #scale_fill_manual(values="#56B4E9")+
  labs(x="Flowering DOY", y = "Count")+
  theme_classic()
```
<br>

Here we see a histogram of all flowering data in our dataset and that it is relatively normally distributed. Let's define our summary statistics: 
```{r calculate sampling stats , include=TRUE, echo=TRUE, out.width=50, out.height=50}
mean(flowdat$doy)
sd(flowdat$doy)
nrow(flowdat)
```
<br>
So there was a mean flowering day of **186.6**, which we can round up to 187 (i.e. July 6th), with a standard deviation of **7.9** or ~8 days, and we have **1188** observations. So using the equation below (with the z statistic as n>30), the 95% confidence interval for the mean flowering time of our population would be:

 $CI = \overline{x}\pm z * s/\sqrt{n}$ 
 <br>

```{r confidence interval , include=TRUE, echo=TRUE,  size=3, out.width=50, out.height=50}
186.6 + 1.96*(7.9/sqrt(1188))
186.6 - 1.96*(7.9/sqrt(1188))
```
<br>

#### QUESTION 1  
When we bring these together, we see our **95% CI = [186.15, 187.05].** Wow, that is a pretty narrow confidence interval!  

Why do you think our confidence interval is so narrow? What does this mean in terms of our sample? Discuss with your group and write your thoughts below!  
<br>
<br>
<br>
<br>
<br>

### Comparing two means 
Let's not forget about our warming experiment --- As we learned, many plants shift their flowering times earlier in response to warmer spring temperatures, which may provide them a reproductive advantage. Do we see evidence of this in our data? Let's plot this same histogram but by treatment group. 

```{r plot flowering by treat, fig.width=4, fig.height=2, fig.align='center', include=TRUE, echo=FALSE, warning=F}
ggplot(flowdat, aes(x=doy, color=otc_treatment, fill=otc_treatment)) +
  #geom_histogram(fill="#56B4E9", color="#56B4E9",position="identity", alpha=0.5, binwidth = 7)+
  geom_histogram(aes(y=..density..), position="identity", alpha=0.5, bins = 20)+ #fill="#56B4E9", color="#56B4E9")+
  geom_density(alpha=0.6)+ #facet_wrap(~spp, scales = "free_x")+
  #geom_vline(data=mu, aes(xintercept=grp.mean, color=sex),
  #           linetype="dashed")+
  scale_color_manual(values=c("cadetblue3", "coral2"))+
  scale_fill_manual(values=c("cadetblue3", "coral2"), labels = c("Control", "Warming"))+
  labs(x="Flowering DOY", y = "Density", fill="Treatment")+ guides(color = "none")+ 
  theme_classic() 
```
 <br>

Here we have a density graph overlaid on our histogram. A density graph shows the area or proportion of the total dataset captured in each bin rather than the counts. 

So we can see that the peak or average flowering time of plants in the warming plots appears slightly earlier than those in control or ambient climate conditions. But how much confidence do we have in this effect? Do we know whether these groups are *actually* different? Let's look at our summary statistics again, this time by group:

```{r table, include=T,  echo=FALSE, warning=FALSE, message=FALSE}
library(flextable)
library(magrittr)
table<-group_by(flowdat,otc_treatment)%>%summarize(MeanDOY=round(mean(doy), 2), Std.deviation=round(sd(doy), 2), N= n())%>%rename(Treatment=otc_treatment)%>%
  mutate(Treatment=ifelse(Treatment== 'OTC', "Warming", "Control"))

table %>% regulartable() %>% autofit() %>% 
width(j=~Treatment,width=1) %>% width(j=~MeanDOY,width=1)%>%width(j=~Std.deviation,width=1)%>%width(j=~N,width=0.5)
```
#### QUESTION 2
Based on this table, calculate a 95% confidence interval for the average flowering time for the warming group and the control group. Write your answers below!
 <br>
 <br>
 <br>
 <br>
 <br>
<br>
<br>

#### Calculate a confidence interval for the difference between two groups
In order to state with confidence that our groups different, we need to  calculate a confidence interval for  the *difference* of our sample means ($\overline{x}_{1}-\overline{x}_{2}$). To do this, we first calculate a pooled estimate of sample standard deviation ($S_p$). This assumes that the that the variances of our two populations are equal, which we can reasonably assume because our sample std. deviations are very similar (**7.84, 7.49**). This value of $S_p$ then gets plugged in to our new CI equation:

 $S_p = \sqrt{(n_1-1)*s_1^2 + (n_2-1)*s_2^2/(n_1+n_2)-2}$
 
 $CI = (\overline{x}_{1}-\overline{x}_{2})\pm z * S_p\sqrt{1/n_1 + 1/n_2 }$ 

 <br>
Other assumptions include that both samples are: 1) randomly drawn from their populations, and 2) have a normal distribution. These both seem reasonable for our data.
<br>
<br>

#### QUESTION 3
Let's assume that you have worked out the math above, and you find that the confidence interval for the difference of our sample means with warming ($\overline{x}_{1}$) and control ($\overline{x}_{2}$) is **-3.7 $\pm$ 0.9** or **[-4.6, -2.8]**

Describe this interval in your own words. Based on this interval, do you think we can conclude that plants flowered earlier under warmer temperatures in our population? Why or why not? What other information (if any) might be helpful? Discuss with your group, and write your thoughts below! 
<br>
<br>
<br>
<br>
<br>
<br>

